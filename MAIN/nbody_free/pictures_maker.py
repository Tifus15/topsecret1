import torch
import matplotlib.pyplot as plt
from data_func import *
import dgl

def H_rollout(model,x):
    hl = []
    for i in range(x.shape[0]):
        hl.append(model(x[i,:,:]).unsqueeze(0))
    return torch.cat((hl),dim=0)
src4 = src_list(4)
print(src4)
src5 = src_list(5)
print(src5)
dst4 = dst_list(4)
print(dst4)
dst5 = dst_list(5)
print(dst5)
src4,dst4 = del_loops(src4,dst4)
src5,dst5 = del_loops(src5,dst5)
    
graph4 = dgl.graph((src4,dst4))
graph5 = dgl.graph((src5,dst5))


t = torch.linspace(0,1.27,128)

x4 = torch.load("showcase/4_x.pt")
print(x4.shape)
h4 = torch.load("showcase/4_h.pt")
print(h4.shape)
x5 = torch.load("showcase/5_x.pt")
print(x5.shape)
h5 = torch.load("showcase/5_h.pt")
print(h5.shape)

#modelnode4 = torch.load("83968085node4_nbody_model_rollout.pth")
#modelnode4.change_graph(graph4)
#modelnode5 = torch.load("83968085node5_nbody_model_rollout.pth")
#modelnode5.change_graph(graph5)

#losses = torch.load("83968085_loss_rollout.pth")


modelnode4 = torch.load("21057874node4_nbody_model_rollout.pth")
modelnode4.change_graph(graph4)
modelnode5 = torch.load("21057874node5_nbody_model_rollout.pth")
modelnode5.change_graph(graph5)

losses = torch.load("21057874_loss_rollout.pth")

TIMESIZE=64

print(losses.shape)
x4 = x4[:TIMESIZE,-1,:,:]
x5 = x5[:TIMESIZE,-1,:,:]
x04 = x4[0,:,:].requires_grad_()
x05 = x5[0,:,:].requires_grad_()
h4e = h4[:TIMESIZE,-1]
h5e = h5[:TIMESIZE,-1]
t = t[:TIMESIZE]

pred4 = RKroll_for_learning(modelnode4,x04,t)
h_pred4 = H_rollout(modelnode4,pred4).squeeze()
print(pred4.shape)
print(h_pred4.shape)
modelnode4.change_graph(graph5)
pred5_4 = RKroll_for_learning(modelnode4,x05,t)
h_pred5_4 = H_rollout(modelnode4,pred5_4).squeeze()
pred5 = RKroll_for_learning(modelnode5,x05,t)
h_pred5 = H_rollout(modelnode5,pred5).squeeze()
modelnode5.change_graph(graph4)
pred4_5 = RKroll_for_learning(modelnode5,x04,t)
h_pred4_5 = H_rollout(modelnode5,pred4_5).squeeze()
t_l = torch.linspace(1,200,200)
print(losses.shape)
fig,ax = plt.subplots(1,2,sharey=True)

ax[0].semilogy(t_l,losses[:,0])
ax[0].semilogy(t_l,losses[:,1])
ax[0].legend(["train","test"])
ax[0].set_title("4 body training (T4)")

ax[1].semilogy(t_l,losses[:,2])
ax[1].semilogy(t_l,losses[:,3])
ax[1].legend(["train","test"])
ax[1].set_title("5 body training (T5)")

fig,ax = plt.subplots(3,4)
ax[0,0].legend(["ground truth", "prediction"])
ax[0,0].plot(x4[:,0,0].detach().numpy(),x4[:,0,3].detach().numpy())
ax[1,0].plot(x4[:,0,1].detach().numpy(),x4[:,0,4].detach().numpy())
ax[2,0].plot(x4[:,0,2].detach().numpy(),x4[:,0,5].detach().numpy())
ax[0,0].scatter(pred4[:,0,0].detach().numpy(),pred4[:,0,3].detach().numpy(),c="r",s=10)
ax[1,0].scatter(pred4[:,0,1].detach().numpy(),pred4[:,0,4].detach().numpy(),c="r",s=10)
ax[2,0].scatter(pred4[:,0,2].detach().numpy(),pred4[:,0,5].detach().numpy(),c="r",s=10)
ax[0,0].set_title("T4 body1_x")
ax[1,0].set_title("T4 body1_y")
ax[2,0].set_title("T4 body1_z")
ax[0,1].plot(x4[:,1,0].detach().numpy(),x4[:,1,3].detach().numpy())
ax[1,1].plot(x4[:,1,1].detach().numpy(),x4[:,1,4].detach().numpy())
ax[2,1].plot(x4[:,1,2].detach().numpy(),x4[:,1,5].detach().numpy())
ax[0,1].scatter(pred4[:,1,0].detach().numpy(),pred4[:,1,3].detach().numpy(),c="r",s=10)
ax[1,1].scatter(pred4[:,1,1].detach().numpy(),pred4[:,1,4].detach().numpy(),c="r",s=10)
ax[2,1].scatter(pred4[:,1,2].detach().numpy(),pred4[:,1,5].detach().numpy(),c="r",s=10)
ax[0,1].set_title("T4 body2_x")
ax[1,1].set_title("T4 body2_y")
ax[2,1].set_title("T4 body2_z")
ax[0,2].plot(x4[:,2,0].detach().numpy(),x4[:,2,3].detach().numpy())
ax[1,2].plot(x4[:,2,1].detach().numpy(),x4[:,2,4].detach().numpy())
ax[2,2].plot(x4[:,2,2].detach().numpy(),x4[:,2,5].detach().numpy())
ax[0,2].scatter(pred4[:,2,0].detach().numpy(),pred4[:,2,3].detach().numpy(),c="r",s=10)
ax[1,2].scatter(pred4[:,2,1].detach().numpy(),pred4[:,2,4].detach().numpy(),c="r",s=10)
ax[2,2].scatter(pred4[:,2,2].detach().numpy(),pred4[:,2,5].detach().numpy(),c="r",s=10)
ax[0,2].set_title("T4 body3_x")
ax[1,2].set_title("T4 body3_y")
ax[2,2].set_title("T4 body3_z")
ax[0,3].plot(x4[:,3,0].detach().numpy(),x4[:,3,3].detach().numpy())
ax[1,3].plot(x4[:,3,1].detach().numpy(),x4[:,3,4].detach().numpy())
ax[2,3].plot(x4[:,3,2].detach().numpy(),x4[:,3,5].detach().numpy())
ax[0,3].scatter(pred4[:,3,0].detach().numpy(),pred4[:,3,3].detach().numpy(),c="r",s=10)
ax[1,3].scatter(pred4[:,3,1].detach().numpy(),pred4[:,3,4].detach().numpy(),c="r",s=10)
ax[2,3].scatter(pred4[:,3,2].detach().numpy(),pred4[:,3,5].detach().numpy(),c="r",s=10)
ax[0,3].set_title("T4 body4_x")
ax[1,3].set_title("T4 body4_y")
ax[2,3].set_title("T4 body4_z")
plt.show()



fig,ax = plt.subplots(3,5)
ax[0,0].legend(["ground truth", "prediction"])
ax[0,0].plot(x5[:,0,0].detach().numpy(),x5[:,0,3].detach().numpy())
ax[1,0].plot(x5[:,0,1].detach().numpy(),x5[:,0,4].detach().numpy())
ax[2,0].plot(x5[:,0,2].detach().numpy(),x5[:,0,5].detach().numpy())
ax[0,0].scatter(pred5_4[:,0,0].detach().numpy(),pred5_4[:,0,3].detach().numpy(),c="r",s=10)
ax[1,0].scatter(pred5_4[:,0,1].detach().numpy(),pred5_4[:,0,4].detach().numpy(),c="r",s=10)
ax[2,0].scatter(pred5_4[:,0,2].detach().numpy(),pred5_4[:,0,5].detach().numpy(),c="r",s=10)
ax[0,0].set_title("T5 body1_x")
ax[1,0].set_title("T5 body1_y")
ax[2,0].set_title("T5 body1_z")
ax[0,1].plot(x5[:,1,0].detach().numpy(),x5[:,1,3].detach().numpy())
ax[1,1].plot(x5[:,1,1].detach().numpy(),x5[:,1,4].detach().numpy())
ax[2,1].plot(x5[:,1,2].detach().numpy(),x5[:,1,5].detach().numpy())
ax[0,1].scatter(pred5_4[:,1,0].detach().numpy(),pred5_4[:,1,3].detach().numpy(),c="r",s=10)
ax[1,1].scatter(pred5_4[:,1,1].detach().numpy(),pred5_4[:,1,4].detach().numpy(),c="r",s=10)
ax[2,1].scatter(pred5_4[:,1,2].detach().numpy(),pred5_4[:,1,5].detach().numpy(),c="r",s=10)
ax[0,1].set_title("T4 body2_x")
ax[1,1].set_title("T4 body2_y")
ax[2,1].set_title("T4 body2_z")
ax[0,2].plot(x5[:,2,0].detach().numpy(),x5[:,2,3].detach().numpy())
ax[1,2].plot(x5[:,2,1].detach().numpy(),x5[:,2,4].detach().numpy())
ax[2,2].plot(x5[:,2,2].detach().numpy(),x5[:,2,5].detach().numpy())
ax[0,2].scatter(pred5_4[:,2,0].detach().numpy(),pred5_4[:,2,3].detach().numpy(),c="r",s=10)
ax[1,2].scatter(pred5_4[:,2,1].detach().numpy(),pred5_4[:,2,4].detach().numpy(),c="r",s=10)
ax[2,2].scatter(pred5_4[:,2,2].detach().numpy(),pred5_4[:,2,5].detach().numpy(),c="r",s=10)
ax[0,2].set_title("T4 body3_x")
ax[1,2].set_title("T4 body3_y")
ax[2,2].set_title("T4 body3_z")
ax[0,3].plot(x5[:,3,0].detach().numpy(),x5[:,3,3].detach().numpy())
ax[1,3].plot(x5[:,3,1].detach().numpy(),x5[:,3,4].detach().numpy())
ax[2,3].plot(x5[:,3,2].detach().numpy(),x5[:,3,5].detach().numpy())
ax[0,3].scatter(pred5_4[:,3,0].detach().numpy(),pred5_4[:,3,3].detach().numpy(),c="r",s=10)
ax[1,3].scatter(pred5_4[:,3,1].detach().numpy(),pred5_4[:,3,4].detach().numpy(),c="r",s=10)
ax[2,3].scatter(pred5_4[:,3,2].detach().numpy(),pred5_4[:,3,5].detach().numpy(),c="r",s=10)
ax[0,3].set_title("T4 body4_x")
ax[1,3].set_title("T4 body4_y")
ax[2,3].set_title("T4 body4_z")

ax[0,4].plot(x5[:,4,0].detach().numpy(),x5[:,4,3].detach().numpy())
ax[1,4].plot(x5[:,4,1].detach().numpy(),x5[:,4,4].detach().numpy())
ax[2,4].plot(x5[:,4,2].detach().numpy(),x5[:,4,5].detach().numpy())
ax[0,4].scatter(pred5_4[:,4,0].detach().numpy(),pred5_4[:,4,3].detach().numpy(),c="r",s=10)
ax[1,4].scatter(pred5_4[:,4,1].detach().numpy(),pred5_4[:,4,4].detach().numpy(),c="r",s=10)
ax[2,4].scatter(pred5_4[:,4,2].detach().numpy(),pred5_4[:,4,5].detach().numpy(),c="r",s=10)
ax[0,4].set_title("T4 body5_x")
ax[1,4].set_title("T4 body5_y")
ax[2,4].set_title("T4 body5_z")



plt.show()

fig,ax = plt.subplots(3,5)
ax[0,0].legend(["ground truth", "prediction"])
ax[0,0].plot(x5[:,0,0].detach().numpy(),x5[:,0,3].detach().numpy())
ax[1,0].plot(x5[:,0,1].detach().numpy(),x5[:,0,4].detach().numpy())
ax[2,0].plot(x5[:,0,2].detach().numpy(),x5[:,0,5].detach().numpy())
ax[0,0].scatter(pred5[:,0,0].detach().numpy(),pred5[:,0,3].detach().numpy(),c="r",s=10)
ax[1,0].scatter(pred5[:,0,1].detach().numpy(),pred5[:,0,4].detach().numpy(),c="r",s=10)
ax[2,0].scatter(pred5[:,0,2].detach().numpy(),pred5[:,0,5].detach().numpy(),c="r",s=10)
ax[0,0].set_title("T5 body1_x")
ax[1,0].set_title("T5 body1_y")
ax[2,0].set_title("T5 body1_z")

ax[0,1].plot(x5[:,1,0].detach().numpy(),x5[:,1,3].detach().numpy())
ax[1,1].plot(x5[:,1,1].detach().numpy(),x5[:,1,4].detach().numpy())
ax[2,1].plot(x5[:,1,2].detach().numpy(),x5[:,1,5].detach().numpy())
ax[0,1].scatter(pred5[:,1,0].detach().numpy(),pred5[:,1,3].detach().numpy(),c="r",s=10)
ax[1,1].scatter(pred5[:,1,1].detach().numpy(),pred5[:,1,4].detach().numpy(),c="r",s=10)
ax[2,1].scatter(pred5[:,1,2].detach().numpy(),pred5[:,1,5].detach().numpy(),c="r",s=10)
ax[0,1].set_title("T5 body2_x")
ax[1,1].set_title("T5 body2_y")
ax[2,1].set_title("T5 body2_z")
ax[0,2].plot(x5[:,2,0].detach().numpy(),x5[:,2,3].detach().numpy())
ax[1,2].plot(x5[:,2,1].detach().numpy(),x5[:,2,4].detach().numpy())
ax[2,2].plot(x5[:,2,2].detach().numpy(),x5[:,2,5].detach().numpy())
ax[0,2].scatter(pred5[:,2,0].detach().numpy(),pred5[:,2,3].detach().numpy(),c="r",s=10)
ax[1,2].scatter(pred5[:,2,1].detach().numpy(),pred5[:,2,4].detach().numpy(),c="r",s=10)
ax[2,2].scatter(pred5[:,2,2].detach().numpy(),pred5[:,2,5].detach().numpy(),c="r",s=10)
ax[0,2].set_title("T5 body3_x")
ax[1,2].set_title("T5 body3_y")
ax[2,2].set_title("T5 body3_z")
ax[0,3].plot(x5[:,3,0].detach().numpy(),x5[:,3,3].detach().numpy())
ax[1,3].plot(x5[:,3,1].detach().numpy(),x5[:,3,4].detach().numpy())
ax[2,3].plot(x5[:,3,2].detach().numpy(),x5[:,3,5].detach().numpy())
ax[0,3].scatter(pred5[:,3,0].detach().numpy(),pred5[:,3,3].detach().numpy(),c="r",s=10)
ax[1,3].scatter(pred5[:,3,1].detach().numpy(),pred5[:,3,4].detach().numpy(),c="r",s=10)
ax[2,3].scatter(pred5[:,3,2].detach().numpy(),pred5[:,3,5].detach().numpy(),c="r",s=10)
ax[0,3].set_title("body4_x")
ax[1,3].set_title("body4_y")
ax[2,3].set_title("body4_z")

ax[0,4].plot(x5[:,4,0].detach().numpy(),x5[:,4,3].detach().numpy())
ax[1,4].plot(x5[:,4,1].detach().numpy(),x5[:,4,4].detach().numpy())
ax[2,4].plot(x5[:,4,2].detach().numpy(),x5[:,4,5].detach().numpy())
ax[0,4].scatter(pred5[:,4,0].detach().numpy(),pred5[:,4,3].detach().numpy(),c="r",s=10)
ax[1,4].scatter(pred5[:,4,1].detach().numpy(),pred5[:,4,4].detach().numpy(),c="r",s=10)
ax[2,4].scatter(pred5[:,4,2].detach().numpy(),pred5[:,4,5].detach().numpy(),c="r",s=10)
ax[0,4].set_title("T5 body5_x")
ax[1,4].set_title("T5 body5_y")
ax[2,4].set_title("T5 body5_z")

plt.show()


fig,ax = plt.subplots(3,4)
ax[0,0].legend(["ground truth", "prediction"])
ax[0,0].plot(x4[:,0,0].detach().numpy(),x4[:,0,3].detach().numpy())
ax[1,0].plot(x4[:,0,1].detach().numpy(),x4[:,0,4].detach().numpy())
ax[2,0].plot(x4[:,0,2].detach().numpy(),x4[:,0,5].detach().numpy())
ax[0,0].scatter(pred4_5[:,0,0].detach().numpy(),pred4_5[:,0,3].detach().numpy(),c="r",s=10)
ax[1,0].scatter(pred4_5[:,0,1].detach().numpy(),pred4_5[:,0,4].detach().numpy(),c="r",s=10)
ax[2,0].scatter(pred4_5[:,0,2].detach().numpy(),pred4_5[:,0,5].detach().numpy(),c="r",s=10)
ax[0,0].set_title("T5 body1_x")
ax[1,0].set_title("T5 body1_y")
ax[2,0].set_title("T5 body1_z")
ax[0,1].plot(x4[:,1,0].detach().numpy(),x4[:,1,3].detach().numpy())
ax[1,1].plot(x4[:,1,1].detach().numpy(),x4[:,1,4].detach().numpy())
ax[2,1].plot(x4[:,1,2].detach().numpy(),x4[:,1,5].detach().numpy())
ax[0,1].scatter(pred4_5[:,1,0].detach().numpy(),pred4_5[:,1,3].detach().numpy(),c="r",s=10)
ax[1,1].scatter(pred4_5[:,1,1].detach().numpy(),pred4_5[:,1,4].detach().numpy(),c="r",s=10)
ax[2,1].scatter(pred4_5[:,1,2].detach().numpy(),pred4_5[:,1,5].detach().numpy(),c="r",s=10)
ax[0,1].set_title("T5 body2_x")
ax[1,1].set_title("T5 body2_y")
ax[2,1].set_title("T5 body2_z")
ax[0,2].plot(x4[:,2,0].detach().numpy(),x4[:,2,3].detach().numpy())
ax[1,2].plot(x4[:,2,1].detach().numpy(),x4[:,2,4].detach().numpy())
ax[2,2].plot(x4[:,2,2].detach().numpy(),x4[:,2,5].detach().numpy())
ax[0,2].scatter(pred4_5[:,2,0].detach().numpy(),pred4_5[:,2,3].detach().numpy(),c="r",s=10)
ax[1,2].scatter(pred4_5[:,2,1].detach().numpy(),pred4_5[:,2,4].detach().numpy(),c="r",s=10)
ax[2,2].scatter(pred4_5[:,2,2].detach().numpy(),pred4_5[:,2,5].detach().numpy(),c="r",s=10)
ax[0,2].set_title("T5 body3_x")
ax[1,2].set_title("T5 body3_y")
ax[2,2].set_title("T5 body3_z")
ax[0,3].plot(x4[:,3,0].detach().numpy(),x4[:,3,3].detach().numpy())
ax[1,3].plot(x4[:,3,1].detach().numpy(),x4[:,3,4].detach().numpy())
ax[2,3].plot(x4[:,3,2].detach().numpy(),x4[:,3,5].detach().numpy())
ax[0,3].scatter(pred4_5[:,3,0].detach().numpy(),pred4_5[:,3,3].detach().numpy(),c="r",s=10)
ax[1,3].scatter(pred4_5[:,3,1].detach().numpy(),pred4_5[:,3,4].detach().numpy(),c="r",s=10)
ax[2,3].scatter(pred4_5[:,3,2].detach().numpy(),pred4_5[:,3,5].detach().numpy(),c="r",s=10)
ax[0,3].set_title("T5 body4_x")
ax[1,3].set_title("T5 body4_y")
ax[2,3].set_title("T5 body4_z")
plt.show()



fig,ax = plt.subplots(2,2)
ax[0,0].set_title("T4 Hamiltonian 4body")
ax[0,0].plot(t,h4e.detach().numpy())
ax[0,0].scatter(t,h_pred4 .detach().numpy(),c="r",s=10)
ax[0,0].legend(["ground truth", "prediction"])
ax[0,1].plot(t,h4e.detach().numpy())
ax[0,1].set_title("T4 Hamiltonian 5body")
ax[0,1].scatter(t,h_pred4_5 .detach().numpy(),c="r",s=10)
ax[0,1].legend(["ground truth", "prediction"])

ax[1,0].set_title("T5 Hamiltonian 5body")
ax[1,0].plot(t,h5e.detach().numpy())
ax[1,0].scatter(t,h_pred5 .detach().numpy(),c="r",s=10)
ax[1,0].legend(["ground truth", "prediction"])
ax[1,1].set_title("T5 Hamiltonian 4body")
ax[1,1].plot(t,h5e.detach().numpy())
ax[1,1].scatter(t,h_pred5_4.detach().numpy(),c="r",s=10)
ax[1,1].legend(["ground truth", "prediction"])

plt.show()







